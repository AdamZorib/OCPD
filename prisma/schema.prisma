// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

model Quote {
  id                    String   @id @default(cuid())
  clientNIP             String
  clientName            String?
  clientEmail           String?
  clientPhone           String?
  clientStreet          String?
  clientHouseNumber     String?
  clientApartmentNumber String?
  clientCity            String?
  clientPostalCode      String?
  clientVoivodeship     String?
  yearsInBusiness       Int?
  fleetSize             Int?
  
  // Policy params
  sumInsured            Decimal
  territorialScope      String
  policyDuration        Int?
  cargoType             String?
  subcontractorPercent  Int?
  paymentInstallments   Int?
  deductibleLevel       String?
  
  // APK Data (stored as JSON string)
  apkDataJson           String?
  
  // Clauses (stored as comma-separated)
  selectedClauses       String?
  selectedVariant       String?
  
  // Calculation result (stored as JSON string)
  calculationResultJson String?
  
  // Vehicles (stored as JSON string)
  vehiclesJson          String?
  
  // Status: DRAFT, CALCULATED, SENT, ACCEPTED, REJECTED, EXPIRED
  status                String   @default("DRAFT")
  brokerId              String?
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Indexes for common queries
  @@index([clientNIP])
  @@index([status])
  @@index([brokerId])
  @@index([createdAt])
}

model Policy {
  id                    String   @id @default(cuid())
  policyNumber          String   @unique
  clientId              String
  clientNIP             String
  clientName            String?
  // Type: OCPD, OCP, OCS
  type                  String   @default("OCPD")
  // Status: DRAFT, QUOTED, ACTIVE, EXPIRED, CANCELLED
  status                String   @default("DRAFT")
  
  sumInsured            Decimal
  // Scope: POLAND, EUROPE, WORLD
  territorialScope      String
  basePremium           Decimal?
  clausesPremium        Decimal?
  totalPremium          Decimal?
  
  // Clauses stored as JSON
  clausesJson           String?
  
  validFrom             DateTime?
  validTo               DateTime?
  issuedAt              DateTime?
  
  apkCompleted          Boolean  @default(false)
  ipidGenerated         Boolean  @default(false)
  
  signatureStatus       String?
  signatureId           String?
  signedAt              DateTime?
  
  brokerId              String?
  underwriterId         String?
  
  // Optimistic locking
  version               Int      @default(1)
  
  // Soft delete for audit compliance
  deletedAt             DateTime?
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  client                Client   @relation(fields: [clientId], references: [id], onDelete: Restrict)
  claims                Claim[]
  certificates          InsuranceCertificate[]

  // Indexes for common queries
  @@index([clientId])
  @@index([status])
  @@index([brokerId])
  @@index([validTo])
  @@index([createdAt])
  @@index([deletedAt])
}

model Client {
  id                    String   @id @default(cuid())
  nip                   String   @unique
  regon                 String?
  name                  String
  email                 String?
  phone                 String?
  
  street                String?
  houseNumber           String?
  apartmentNumber       String?
  city                  String?
  postalCode            String?
  voivodeship           String?
  
  // Complex data stored as JSON
  regonDataJson         String?
  riskProfileJson       String?
  fleetJson             String?
  claimsHistoryJson     String?
  
  brokerId              String?
  
  // Optimistic locking
  version               Int      @default(1)
  
  // Soft delete for audit compliance
  deletedAt             DateTime?
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  policies              Policy[]
  claims                Claim[]
  certificates          InsuranceCertificate[]

  // Indexes for common queries
  @@index([brokerId])
  @@index([createdAt])
  @@index([deletedAt])
}

model Claim {
  id             String   @id @default(cuid())
  claimNumber    String   @unique
  policyId       String
  clientId       String
  incidentDate   DateTime
  reportedDate   DateTime
  description    String
  location       String?
  claimedAmount  Decimal
  reservedAmount Decimal?
  paidAmount     Decimal?
  // Status: REPORTED, UNDER_REVIEW, APPROVED, REJECTED, PAID, CLOSED
  status         String   @default("REPORTED")
  documentsJson  String?
  
  // Idempotency key to prevent duplicate submissions
  idempotencyKey String?  @unique
  
  // Optimistic locking
  version        Int      @default(1)
  
  // Soft delete for audit compliance
  deletedAt      DateTime?
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  policy         Policy   @relation(fields: [policyId], references: [id], onDelete: Restrict)
  client         Client   @relation(fields: [clientId], references: [id], onDelete: Restrict)

  // Indexes for common queries
  @@index([policyId])
  @@index([clientId])
  @@index([status])
  @@index([createdAt])
  @@index([deletedAt])
}

model InsuranceCertificate {
  id                String   @id @default(cuid())
  certificateNumber String   @unique
  policyId          String
  clientId          String

  // Snapshot fields - copied from policy/client for historical stability
  policyNumber      String
  clientName        String

  cargoDescription  String
  cargoValue        Decimal
  route             String
  transportDate     DateTime

  // Status: ACTIVE, REVOKED
  status            String   @default("ACTIVE")

  // Revocation tracking
  revokedAt         DateTime?
  revokedById       String?
  revocationReason  String?

  brokerId          String?
  createdById       String?  // Audit: who created this certificate

  // Soft delete for audit compliance
  deletedAt         DateTime?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  policy            Policy   @relation(fields: [policyId], references: [id], onDelete: Restrict)
  client            Client   @relation(fields: [clientId], references: [id], onDelete: Restrict)

  // Indexes for common queries
  @@index([policyId])
  @@index([clientId])
  @@index([brokerId])
  @@index([createdById])
  @@index([status])
  @@index([createdAt])
  @@index([deletedAt])
}
